# Rate limiting zones
limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=auth:10m rate=1r/s;
limit_req_zone $binary_remote_addr zone=api:10m rate=20r/s;
limit_conn_zone $binary_remote_addr zone=conn:10m;

upstream api {
    server api:9000;
    keepalive 32;
}

server {
    listen 80;
    server_name localhost;

    # Request size limits
    client_max_body_size 10M;
    client_body_buffer_size 128k;

    # Timeouts
    client_body_timeout 12;
    client_header_timeout 12;
    keepalive_timeout 15;
    send_timeout 10;

    # Hide Nginx version
    server_tokens off;

    # Security headers (applied to all responses)
    add_header X-Content-Type-Options nosniff always;
    add_header X-Frame-Options DENY always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

    # ============================================
    # BLOCK MALICIOUS PATHS BEFORE PROXY
    # ============================================

    # Block PHP files and related attacks
    location ~* \.(php|phtml|php3|php4|php5|php7|phps|cgi|pl|asp|aspx|jsp)$ {
        return 404;
    }

    # Block Git/SVN/Version Control
    location ~ /\.(git|svn|hg|bzr) {
        return 404;
    }

    # Block environment and config files
    location ~ /\.(env|htaccess|htpasswd|ini|log|sh|sql|conf|config)$ {
        return 404;
    }

    # Block PHPUnit vulnerability paths (CVE-2017-9841)
    location ~* (eval-stdin|phpunit|vendor/phpunit) {
        return 404;
    }

    # Block ThinkPHP RCE attempts
    location ~* (thinkphp|invokefunction|call_user_func) {
        return 404;
    }

    # Block Docker API access attempts
    location ~* (containers/json|docker\.sock|_ping|v1\.\d+/containers) {
        return 404;
    }

    # Block Router/IoT exploit paths
    location ~* (luci|cgi-bin|webLanguage|/SDK|goform|formLogin|developmentserver|metadatauploader) {
        return 404;
    }

    # Block WordPress paths
    location ~* (wp-admin|wp-content|wp-includes|wp-login|xmlrpc\.php|wp-config) {
        return 404;
    }

    # Block Laravel/Framework paths
    location ~* (artisan|\.blade\.php|vendor/laravel|laravel|yii|zend) {
        return 404;
    }

    # Block backup and sensitive files
    location ~* \.(bak|old|backup|sql|tar|gz|zip|rar|dump)$ {
        return 404;
    }

    # Block admin panels and config files
    location ~* (phpmyadmin|adminer|manager/html|admin\.php|config\.php|settings\.php|credentials) {
        return 404;
    }

    # Block service discovery and info endpoints
    location ~* (actuator|service/api-docs|swagger|/bins/) {
        return 404;
    }

    # Block robots.txt (we don't have one)
    location = /robots.txt {
        return 404;
    }

    # ============================================
    # LEGITIMATE API ROUTES
    # ============================================

    # Auth endpoints - strict rate limiting
    location /api/v1/auth/ {
        limit_req zone=auth burst=5 nodelay;
        limit_conn conn 10;

        proxy_pass http://api;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
    }

    # API routes with moderate rate limiting
    location /api/ {
        limit_req zone=api burst=20 nodelay;
        limit_conn conn 50;

        proxy_pass http://api;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;

        # Important: Don't buffer responses for SSE/streaming
        proxy_buffering off;

        # Timeouts for long-running requests
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }

    # Health check endpoint
    location /health {
        limit_req zone=general burst=10 nodelay;

        proxy_pass http://api/health;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Root endpoint
    location = / {
        limit_req zone=general burst=10 nodelay;

        proxy_pass http://api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Catch-all: return 404 for anything else
    location / {
        return 404;
    }

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1000;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml;

    # Custom error pages (JSON format)
    error_page 403 = @forbidden;
    error_page 404 = @notfound;
    error_page 429 = @ratelimited;

    location @forbidden {
        default_type application/json;
        return 403 '{"detail": "Access denied"}';
    }

    location @notfound {
        default_type application/json;
        return 404 '{"detail": "Not found"}';
    }

    location @ratelimited {
        default_type application/json;
        return 429 '{"detail": "Too many requests. Please try again later."}';
    }

    # Access and error logs with security format
    log_format security '$remote_addr - $remote_user [$time_local] '
                       '"$request" $status $body_bytes_sent '
                       '"$http_referer" "$http_user_agent" '
                       '$request_time $upstream_response_time';

    access_log /var/log/nginx/access.log security;
    error_log /var/log/nginx/error.log warn;
}
